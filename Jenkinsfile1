pipeline{

    agent any
    tools{
        maven "Maven"
    }
    stages{

        stage('Git checkout'){
            steps{
                git branch: 'master', url: 'https://github.com/goswami97/testingrepo.git'
            }
        }
        stage('Code build'){
            steps{
                script{
                    sh '''
                    LATEST_TAG=$(git  describe --tag | awk -F "-" '{print $1}')
					major=$(echo "$LATEST_TAG" | awk -F "." '{print $1}')
					minor=$(echo "$LATEST_TAG" | awk -F "." '{print $2}')
					patch=$(echo "$LATEST_TAG" | awk -F "." '{print $3}')

					echo "major $major"
					echo "minor $minor"
					echo "patch $patch"

					newpatch=$(expr $patch + 1)
					echo "new patch $newpatch"

					new_tag="${major}.${minor}.${newpatch}"
					echo "the new git tag generated $new_tag"
					
                    mvn clean package
                    
                    git tag "$new_tag"
					git push https://goswami97:"$githubAccessToken"@github.com/goswami97/testingrepo.git --tags
					echo $new_tag > /tmp/buildNo
                    '''
                }
            }
        }
        stage('Copy to build forlder'){

            steps{
                script{
                    sh '''
                    scp /var/lib/jenkins/workspace/ScriptedPipeline/target/*.war /home/projectX/
                    '''
                }
            }
        }
        stage('Docker Build and Tag'){

            steps{

                script{

                    sh '''
                    cd /home/projectX/
					new_tag=$(cat /tmp/buildNo)
                    docker login --username "$dockerid" --password "$dockerpass"
                    docker build -t santoshgoswami/samplewebapp:$new_tag .
                    #docker tag samplewebapp:$new_tag santoshgoswami/samplewebapp:$new_tag
                    '''
                }
            }
        }
        stage('Docker image push to docker hub'){

            steps{

                script{
                        sh '''
						new_tag=$(cat /tmp/buildNo)
                        docker push santoshgoswami/samplewebapp:$new_tag
                        #docker push santoshgoswami/samplewebapp:$BUILD_NUMBER
                        '''
                }
            }
        }
        stage('Deploy container in Remote server'){

            steps{

                script{
                    
                    sh '''
					new_tag=$(cat /tmp/buildNo)
                    ssh jnsadmin@172.31.33.26 'docker rm $(docker ps -qa) -f'
                    docker -H ssh://jnsadmin@172.31.33.26 run -d -p 8000:8080 santoshgoswami/samplewebapp
                    '''
                }
            }
        }


    }
}
